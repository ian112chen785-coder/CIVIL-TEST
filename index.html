<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AI Note v1</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ios: {
                            bg: '#000000',
                            card: '#111111', 
                            cardTrans: 'rgba(17, 17, 17, 0.85)',
                            blue: '#3b82f6', 
                            deepBlue: '#172554', 
                            deepPurple: '#3b0764', 
                            deepGreen: '#052e16', 
                            red: '#FF3B30',
                            green: '#34C759',
                            yellow: '#FFD60A',
                            gray: '#8E8E93',
                            separator: '#333333',
                            input: '#222222',
                        }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'SF Pro Text', 'Helvetica Neue', 'Helvetica', 'sans-serif'],
                    },
                    padding: {
                        'safe': 'env(safe-area-inset-top)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: -apple-system, sans-serif;
            padding-bottom: env(safe-area-inset-bottom);
            padding-top: env(safe-area-inset-top);
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* iOS Glassmorphism */
        .ios-card {
            background: rgba(28, 28, 30, 0.6);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 0.5px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px; 
        }

        .ios-input {
            background: #222222;
            color: white;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s ease;
        }
        .ios-input:focus {
            background: #2a2a2a;
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.3); /* Slight neon on focus */
        }

        .ios-btn {
            background: #3b82f6;
            color: white;
            font-weight: 600;
            border-radius: 14px;
            border: none;
            transition: transform 0.1s;
        }
        
        .ios-btn-sec {
            background: rgba(142, 142, 147, 0.2);
            color: #fff;
            border-radius: 14px;
            font-weight: 500;
            transition: transform 0.1s;
        }

        /* Animation: Jelly Effect for Clicks */
        @keyframes jelly {
            0% { transform: scale(1); }
            25% { transform: scale(0.95); }
            50% { transform: scale(1.05); }
            75% { transform: scale(0.98); }
            100% { transform: scale(1); }
        }

        .ios-btn:active, .ios-btn-sec:active, .fab-toggle:active, .jelly-click:active { 
            animation: jelly 0.4s ease;
            opacity: 0.9;
        }

        /* Animation: Neon Focus for Input Capsule */
        .neon-focus:focus-within {
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.4), 0 0 30px rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.6);
        }

        /* Utilities */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        .markdown-body { font-size: 16px; line-height: 1.5; color: #e5e5e5; }
        .markdown-body h1, .markdown-body h2 { border-bottom: 0.5px solid #333; padding-bottom: 0.3em; margin-top: 1em; color: white; font-weight: 700; }
        .markdown-body code { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 6px; color: #FFD60A; font-family: 'SF Mono', monospace; font-size: 0.9em; }
        .markdown-body pre { background: #111; padding: 12px; border-radius: 12px; overflow-x: auto; border: 0.5px solid #333; }
        .markdown-body img { max-width: 100%; border-radius: 12px; margin: 10px 0; }
        
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .fab-toggle {
            position: absolute; bottom: 80px; right: 24px;
            width: 50px; height: 50px; border-radius: 25px;
            background: #3b82f6; color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; z-index: 50; transition: transform 0.2s;
        }
        
        /* Auto-growing textarea hiding scrollbar */
        textarea.auto-grow {
            overflow: hidden;
            min-height: 24px; /* Reduced min height */
            max-height: 120px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        const Icons = {
            Book: () => <i className="fas fa-book"></i>,
            Chart: () => <i className="fas fa-chart-pie"></i>,
            Robot: () => <i className="fas fa-robot"></i>,
            Calendar: () => <i className="fas fa-calendar-alt"></i>,
            Settings: () => <i className="fas fa-cog"></i>,
            Plus: () => <i className="fas fa-plus"></i>,
            Trash: () => <i className="fas fa-trash-alt"></i>,
            Edit: () => <i className="fas fa-pen"></i>,
            Save: () => <i className="fas fa-save"></i>,
            ArrowRight: () => <i className="fas fa-chevron-right"></i>,
            ArrowLeft: () => <i className="fas fa-chevron-left"></i>,
            Camera: () => <i className="fas fa-camera"></i>,
            Send: () => <i className="fas fa-paper-plane"></i>,
            Link: () => <i className="fas fa-link"></i>,
            Times: () => <i className="fas fa-times"></i>,
            Scan: () => <i className="fas fa-magic"></i>,
            Eye: () => <i className="fas fa-eye"></i>, 
            Code: () => <i className="fas fa-code"></i>,
            Image: () => <i className="fas fa-image"></i>,
            Move: () => <i className="fas fa-arrows-alt"></i>,
            Palette: () => <i className="fas fa-palette"></i>,
            Download: () => <i className="fas fa-file-export"></i>,
            Upload: () => <i className="fas fa-file-import"></i>,
            Grad: () => <i className="fas fa-graduation-cap"></i>,
        };

        const MarkdownRenderer = ({ content }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current) {
                    let html = marked.parse(content || '');
                    containerRef.current.innerHTML = html;
                    if (window.renderMathInElement) {
                        window.renderMathInElement(containerRef.current, {
                            delimiters: [
                                {left: '$$', right: '$$', display: true},
                                {left: '$', right: '$', display: false}
                            ],
                            throwOnError: false
                        });
                    }
                }
            }, [content]);
            return <div className="markdown-body select-text" ref={containerRef} />;
        };

        const callGeminiVision = async (apiKey, text, base64Image) => {
            const body = {
                contents: [{
                    parts: [
                        { text: text },
                        ...(base64Image ? [{ inlineData: { mimeType: "image/jpeg", data: base64Image } }] : [])
                    ]
                }]
            };
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await res.json();
            return data.candidates[0].content.parts[0].text;
        };

        function App() {
            const [view, setView] = useState('dashboard'); 
            const [subjects, setSubjects] = useState([]);
            const [logs, setLogs] = useState([]);
            const [apiKey, setApiKey] = useState('');
            const [examDate, setExamDate] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            const fileInputRef = useRef(null);
            
            useEffect(() => {
                const s = localStorage.getItem('civil_pro_subjects_v7');
                const l = localStorage.getItem('civil_pro_logs_v7');
                const k = localStorage.getItem('civil_pro_apikey');
                const e = localStorage.getItem('civil_pro_exam_date');
                if (s) setSubjects(JSON.parse(s));
                if (l) setLogs(JSON.parse(l));
                if (k) setApiKey(k);
                if (e) setExamDate(e);
            }, []);

            useEffect(() => localStorage.setItem('civil_pro_subjects_v7', JSON.stringify(subjects)), [subjects]);
            useEffect(() => localStorage.setItem('civil_pro_logs_v7', JSON.stringify(logs)), [logs]);
            useEffect(() => localStorage.setItem('civil_pro_apikey', apiKey), [apiKey]);
            useEffect(() => localStorage.setItem('civil_pro_exam_date', examDate), [examDate]);

            const calculateTotalProgress = () => {
                let total = 0, count = 0;
                subjects.forEach(s => s.chapters.forEach(c => { total += parseInt(c.progress || 0); count++; }));
                return count === 0 ? 0 : Math.round(total / count);
            };

            const addSubject = (name) => setSubjects([...subjects, { id: Date.now(), name, chapters: [] }]);
            const deleteSubject = (id) => setSubjects(subjects.filter(s => s.id !== id));
            
            const addChapter = (sid, name) => {
                setSubjects(subjects.map(s => s.id === sid ? {
                    ...s, chapters: [...s.chapters, { id: Date.now(), name, progress: 0, notes: { core: '', formula: '', example: '', mindmapNodes: [], mindmapEdges: [] } }]
                } : s));
            };
            const deleteChapter = (sid, cid) => {
                setSubjects(subjects.map(s => s.id === sid ? { ...s, chapters: s.chapters.filter(c => c.id !== cid) } : s));
            };
            const updateChapterData = (sid, cid, data) => {
                setSubjects(subjects.map(s => s.id === sid ? {
                    ...s, chapters: s.chapters.map(c => c.id === cid ? { ...c, ...data } : c)
                } : s));
            };
            const deleteLog = (id) => { if(confirm('確定刪除此紀錄？')) setLogs(logs.filter(l => l.id !== id)); };

            // Backup & Restore
            const handleBackup = () => {
                const data = { subjects, logs, apiKey, examDate, version: 'v8' };
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ai_note_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            };

            const handleRestore = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if(data.subjects) setSubjects(data.subjects);
                        if(data.logs) setLogs(data.logs);
                        if(data.apiKey) setApiKey(data.apiKey);
                        if(data.examDate) setExamDate(data.examDate);
                        alert('還原成功！資料已更新。');
                        setShowSettings(false);
                    } catch (err) { alert('檔案格式錯誤'); }
                };
                reader.readAsText(file);
            };

            return (
                <div className="h-[100dvh] flex flex-col bg-ios-bg text-white font-sans overflow-hidden">
                    {/* Header: Updated Title & Icon */}
                    <div className="pt-safe mt-4 px-4 pb-2 flex items-center justify-between bg-black/80 backdrop-blur z-50">
                        <div className="flex items-center gap-2"> 
                            <h1 className="text-xl font-bold tracking-tight text-white">AI Note App</h1>
                        </div>
                        <button onClick={() => setShowSettings(true)} className="w-8 h-8 bg-ios-input rounded-full flex items-center justify-center text-ios-blue jelly-click"><Icons.Settings /></button>
                    </div>

                    {/* Main Content */}
                    <main className="flex-1 p-4 overflow-y-auto pb-24 scroll-smooth">
                        {view === 'dashboard' && <Dashboard subjects={subjects} totalProgress={calculateTotalProgress()} setView={setView} examDate={examDate} />}
                        {view === 'subjects' && <SubjectManager subjects={subjects} addSubject={addSubject} deleteSubject={deleteSubject} addChapter={addChapter} deleteChapter={deleteChapter} updateChapterData={updateChapterData} apiKey={apiKey} />}
                        {view === 'ai' && <AIConsultant apiKey={apiKey} />}
                        {view === 'calendar' && <StudyCalendar logs={logs} setLogs={setLogs} deleteLog={deleteLog} subjects={subjects} examDate={examDate} setExamDate={setExamDate} />}
                    </main>

                    {/* Tab Bar: Updated Spacing and Icons */}
                    <div className="fixed bottom-0 left-0 right-0 bg-ios-card/90 backdrop-blur-xl border-t border-ios-separator pb-safe z-40 h-[80px]">
                        <div className="flex justify-between items-center h-full px-2">
                            <NavBtn active={view === 'dashboard'} onClick={() => setView('dashboard')} icon={<Icons.Chart />} label="摘要" />
                            <NavBtn active={view === 'subjects'} onClick={() => setView('subjects')} icon={<Icons.Book />} label="筆記" />
                            <NavBtn active={view === 'ai'} onClick={() => setView('ai')} icon={<Icons.Robot />} label="AI" />
                            <NavBtn active={view === 'calendar'} onClick={() => setView('calendar')} icon={<Icons.Calendar />} label="進度" />
                        </div>
                    </div>

                    {/* Settings Modal with Backup/Restore */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
                            <div className="ios-card p-6 w-full max-w-sm bg-[#111]">
                                <h3 className="text-xl font-bold text-white mb-4 text-center">設定</h3>
                                
                                <div className="mb-6 space-y-4">
                                    <div>
                                        <label className="block text-xs text-ios-gray mb-2 ml-1">Gemini API Key</label>
                                        <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} className="ios-input w-full p-4 text-base" placeholder="在此貼上 API Key" />
                                    </div>
                                    
                                    <div>
                                        <label className="block text-xs text-ios-gray mb-2 ml-1">資料備份與還原</label>
                                        <div className="flex gap-2">
                                            <button onClick={handleBackup} className="ios-btn-sec flex-1 py-3 flex items-center justify-center gap-2 jelly-click">
                                                <Icons.Download /> 匯出
                                            </button>
                                            <button onClick={() => fileInputRef.current.click()} className="ios-btn-sec flex-1 py-3 flex items-center justify-center gap-2 jelly-click">
                                                <Icons.Upload /> 匯入
                                            </button>
                                            <input type="file" ref={fileInputRef} className="hidden" accept=".json" onChange={handleRestore} />
                                        </div>
                                    </div>
                                </div>

                                <button onClick={() => setShowSettings(false)} className="ios-btn w-full py-3.5 text-base jelly-click">完成</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const NavBtn = ({ active, onClick, icon, label }) => (
            <button onClick={onClick} className="relative flex flex-col items-center justify-center flex-1 h-full gap-1 group jelly-click">
                <div className={`text-2xl transition-all duration-300 ${active ? 'text-ios-blue scale-110' : 'text-ios-gray'}`}>{icon}</div>
                <div className={`text-xs font-semibold transition-colors duration-200 ${active ? 'text-white' : 'text-ios-gray'}`}>{label}</div>
            </button>
        );

        const Dashboard = ({ subjects, totalProgress, setView, examDate }) => {
            const daysLeft = examDate ? Math.ceil((new Date(examDate) - new Date())/(1000*60*60*24)) : null;
            return (
                <div className="space-y-4 animate-fade-in">
                    {/* Updated Gradient Card */}
                    <div className="ios-card p-6 relative overflow-hidden bg-gradient-to-br from-ios-deepBlue/40 via-ios-deepPurple/20 to-black border border-white/10 jelly-click active:scale-95 transition-transform duration-200">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-ios-blue opacity-20 blur-[50px] rounded-full translate-x-10 -translate-y-10"></div>
                        <div className="flex justify-between items-start mb-2">
                            <div className="text-xs text-ios-blue font-bold uppercase tracking-wider">總學習進度</div>
                            {daysLeft !== null && <div className="text-xs text-gray-300 font-bold">考前衝刺</div>}
                        </div>
                        <div className="flex items-end gap-2 mb-4">
                            <span className="text-5xl font-bold text-white">{totalProgress}</span>
                            <span className="text-xl text-ios-gray mb-1">%</span>
                        </div>
                        <div className="h-2 bg-white/10 rounded-full overflow-hidden mb-2">
                            <div className="h-full bg-gradient-to-r from-ios-blue to-ios-purple transition-all duration-1000 shadow-[0_0_10px_rgba(59,130,246,0.5)]" style={{width: `${totalProgress}%`}}></div>
                        </div>
                        {daysLeft !== null && (
                            <div className="text-xs text-right text-ios-gray">
                                距離考試還有 <span className="text-white font-bold text-sm">{daysLeft}</span> 天
                            </div>
                        )}
                    </div>

                    <div className="grid grid-cols-1 gap-3">
                        {subjects.map(s => {
                             const p = s.chapters.length ? Math.round(s.chapters.reduce((a,c)=>a+(c.progress||0),0)/s.chapters.length) : 0;
                             return (
                                <div key={s.id} onClick={() => setView('subjects')} className="ios-card p-5 jelly-click active:bg-ios-input transition-colors flex justify-between items-center bg-[#111]">
                                    <div className="flex-1">
                                        <h3 className="font-bold text-white text-lg mb-1">{s.name}</h3>
                                        <div className="flex items-center gap-2">
                                            <div className="h-1.5 w-24 bg-white/10 rounded-full overflow-hidden">
                                                <div className="h-full bg-ios-green shadow-[0_0_5px_rgba(52,199,89,0.4)]" style={{width: `${p}%`}}></div>
                                            </div>
                                            <span className="text-xs text-ios-gray">{p}%</span>
                                        </div>
                                    </div>
                                    <div className="text-ios-gray"><Icons.ArrowRight /></div>
                                </div>
                             )
                        })}
                    </div>
                </div>
            );
        };

        const SubjectManager = ({ subjects, addSubject, deleteSubject, addChapter, deleteChapter, updateChapterData, apiKey }) => {
            const [activeSubjId, setActiveSubjId] = useState(null);
            const [editingChapter, setEditingChapter] = useState(null);
            const [newSubjName, setNewSubjName] = useState('');

            const activeSubj = subjects.find(s => s.id === activeSubjId);

            if (editingChapter) {
                return <FullEditor subjectId={editingChapter.subjectId} chapter={editingChapter.chapter} onClose={() => setEditingChapter(null)} onSave={(d) => updateChapterData(editingChapter.subjectId, editingChapter.chapter.id, d)} apiKey={apiKey} />;
            }

            if (activeSubj) {
                return (
                    <div className="animate-fade-in h-full flex flex-col">
                        <button onClick={() => setActiveSubjId(null)} className="flex items-center gap-1 text-ios-blue mb-4 font-medium text-base">
                            <Icons.ArrowLeft /> 科目列表
                        </button>
                        <div className="mb-6">
                            <h2 className="text-3xl font-bold text-white mb-4">{activeSubj.name}</h2>
                            <ChapterInput onAdd={(n) => addChapter(activeSubj.id, n)} />
                        </div>
                        <div className="space-y-3 pb-20">
                            {activeSubj.chapters.map(chap => (
                                <div key={chap.id} className="ios-card p-4 bg-[#111] border-white/5">
                                    <div className="flex justify-between items-start mb-4">
                                        <h4 className="font-bold text-lg text-white">{chap.name}</h4>
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); if(confirm('確定刪除此章節？')) deleteChapter(activeSubj.id, chap.id); }} 
                                            className="w-8 h-8 flex items-center justify-center bg-white/10 rounded-full text-ios-red jelly-click"
                                        >
                                            <Icons.Trash />
                                        </button>
                                    </div>
                                    <div className="flex items-center gap-4 mb-4">
                                        <input type="range" className="flex-1 accent-ios-blue h-1 bg-white/10 rounded-lg appearance-none" value={chap.progress} onChange={(e) => updateChapterData(activeSubj.id, chap.id, {progress: parseInt(e.target.value)})} />
                                        <span className="text-sm font-mono text-ios-gray w-8 text-right">{chap.progress}%</span>
                                    </div>
                                    <button onClick={() => setEditingChapter({ subjectId: activeSubj.id, chapter: chap })} className="ios-btn-sec w-full py-3 text-sm flex items-center justify-center gap-2 text-ios-blue bg-ios-deepBlue/30 hover:bg-ios-deepBlue/50 transition jelly-click">
                                        <Icons.Edit /> 進入筆記
                                    </button>
                                </div>
                            ))}
                            {activeSubj.chapters.length === 0 && <div className="text-center text-ios-gray py-10">點擊上方 + 新增章節</div>}
                        </div>
                    </div>
                );
            }

            return (
                <div className="animate-fade-in pb-20">
                    <div className="ios-card p-2 flex gap-2 mb-6 bg-[#111]">
                        <input value={newSubjName} onChange={(e) => setNewSubjName(e.target.value)} placeholder="輸入新科目名稱..." className="flex-1 bg-transparent px-3 text-base outline-none text-white placeholder-gray-500" />
                        <button onClick={() => { if(newSubjName){ addSubject(newSubjName); setNewSubjName(''); }}} className="w-10 h-10 bg-ios-blue rounded-lg text-white flex items-center justify-center jelly-click"><Icons.Plus /></button>
                    </div>
                    <div className="space-y-3">
                        {subjects.map(s => (
                            <div key={s.id} onClick={() => setActiveSubjId(s.id)} className="ios-card p-4 flex justify-between items-center active:bg-white/5 transition bg-[#111] jelly-click">
                                <div className="flex items-center gap-4">
                                    <div className="w-10 h-10 rounded-full bg-ios-deepBlue/50 border border-white/10 flex items-center justify-center text-white"><Icons.Book /></div>
                                    <div>
                                        <div className="font-bold text-lg text-white">{s.name}</div>
                                        <div className="text-xs text-ios-gray">{s.chapters.length} 個章節</div>
                                    </div>
                                </div>
                                <div className="flex items-center gap-4">
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); if(confirm(`確定刪除 ${s.name}?`)) deleteSubject(s.id); }} 
                                        className="w-8 h-8 rounded-full bg-white/10 text-ios-gray flex items-center justify-center jelly-click"
                                    >
                                        <Icons.Trash />
                                    </button>
                                    <Icons.ArrowRight />
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ChapterInput = ({ onAdd }) => {
            const [v, sV] = useState('');
            return <div className="flex gap-2"><input value={v} onChange={e=>sV(e.target.value)} placeholder="章節名稱" className="ios-input flex-1 px-4 py-3" /><button onClick={()=>{if(v){onAdd(v);sV('')}}} className="ios-btn px-6 py-3 jelly-click"><Icons.Plus /></button></div>
        }

        const MindMapCanvas = ({ nodes, edges, onChange }) => {
            const svgRef = useRef(null);
            const [draggingId, setDraggingId] = useState(null);
            const [offset, setOffset] = useState({x:0, y:0});
            
            const [mode, setMode] = useState('move'); 
            const [linkSource, setLinkSource] = useState(null); 

            const getPos = (e) => {
                const rect = svgRef.current.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };

            const handleCanvasClick = (e) => {
                if(mode === 'add') {
                    const pos = getPos(e);
                    const newId = Date.now().toString() + Math.random().toString(36).substr(2, 5);
                    const newNode = { id: newId, x: pos.x - 70, y: pos.y - 25, text: 'New', color: '#1c1c1e' };
                    onChange({ nodes: [...nodes, newNode], edges });
                }
            };

            const handleNodeInteraction = (e, id, nx, ny) => {
                e.stopPropagation();
                
                if (mode === 'move') {
                    const pos = getPos(e);
                    setDraggingId(id);
                    setOffset({ x: pos.x - nx, y: pos.y - ny });
                } else if (mode === 'link') {
                    if (!linkSource) {
                        setLinkSource(id);
                    } else {
                        if (linkSource !== id) {
                            // NEW: Check if connection exists to toggle (remove) it
                            const existingIndex = edges.findIndex(edge => 
                                (edge.source === linkSource && edge.target === id) || 
                                (edge.source === id && edge.target === linkSource) // Check both directions or just one? Let's assume directional user intent
                            );
                            
                            // Let's implement exact match removal as per user request ("same direction linking")
                            const exactEdgeIndex = edges.findIndex(edge => edge.source === linkSource && edge.target === id);

                            if (exactEdgeIndex !== -1) {
                                // Remove existing link
                                const newEdges = [...edges];
                                newEdges.splice(exactEdgeIndex, 1);
                                onChange({ nodes, edges: newEdges });
                            } else {
                                // Add new link
                                onChange({ nodes, edges: [...edges, { source: linkSource, target: id }] });
                            }
                        }
                        setLinkSource(null);
                    }
                } else if (mode === 'color') {
                    const colors = ['#1c1c1e', '#8E2121', '#172554', '#052e16', '#3b0764']; 
                    onChange({
                         nodes: nodes.map(n => {
                            if(n.id === id) {
                                const currIdx = colors.indexOf(n.color || '#1c1c1e');
                                const nextColor = colors[(currIdx + 1) % colors.length];
                                return { ...n, color: nextColor };
                            }
                            return n;
                         }),
                         edges 
                    });
                }
            };

            const onMove = (e) => {
                if (!draggingId || mode !== 'move') return;
                const pos = getPos(e);
                onChange({
                    nodes: nodes.map(n => n.id === draggingId ? { ...n, x: pos.x - offset.x, y: pos.y - offset.y } : n),
                    edges
                });
            };

            const stopDrag = () => setDraggingId(null);

            return (
                <div className="relative w-full h-full bg-[#000] overflow-hidden border border-ios-separator" 
                     ref={svgRef} 
                     style={{ touchAction: 'none' }}
                     onMouseMove={onMove} onTouchMove={onMove} 
                     onMouseUp={stopDrag} onTouchEnd={stopDrag}
                     onClick={handleCanvasClick}
                >
                    <div className="absolute bottom-4 left-0 right-0 z-20 flex justify-center gap-2 pointer-events-none">
                        <div className="bg-[#111]/90 backdrop-blur-md p-2 rounded-2xl flex gap-1 pointer-events-auto border border-white/10 shadow-2xl">
                            <ModeBtn active={mode==='move'} onClick={()=>setMode('move')} icon={<Icons.Move />} label="移動" />
                            <ModeBtn active={mode==='add'} onClick={()=>setMode('add')} icon={<Icons.Plus />} label="新增" />
                            <ModeBtn active={mode==='text'} onClick={()=>setMode('text')} icon={<Icons.Edit />} label="文字" />
                            <ModeBtn active={mode==='link'} onClick={()=>{setMode('link');setLinkSource(null);}} icon={<Icons.Link />} label="連結" />
                            <ModeBtn active={mode==='color'} onClick={()=>setMode('color')} icon={<Icons.Palette />} label="顏色" />
                        </div>
                    </div>

                    {linkSource && <div className="absolute top-4 left-1/2 -translate-x-1/2 z-10 bg-ios-yellow text-black px-3 py-1 rounded-full text-xs font-bold animate-pulse">請點擊目標節點</div>}

                    <svg className="absolute inset-0 w-full h-full pointer-events-none">
                        <defs><marker id="arrow" markerWidth="10" markerHeight="10" refX="20" refY="3" orient="auto" markerUnits="strokeWidth"><path d="M0,0 L0,6 L9,3 z" fill="#555" /></marker></defs>
                        {edges.map((e, i) => {
                            const s = nodes.find(n => n.id === e.source), t = nodes.find(n => n.id === e.target);
                            return s && t ? <line key={i} x1={s.x+70} y1={s.y+25} x2={t.x+70} y2={t.y+25} stroke="#555" strokeWidth="2" markerEnd="url(#arrow)" /> : null;
                        })}
                    </svg>

                    {nodes.map(n => (
                        <div key={n.id} 
                             className={`absolute w-[140px] h-[50px] rounded-xl border flex items-center justify-center text-white text-sm shadow-lg select-none transition-transform 
                                ${linkSource === n.id ? 'border-ios-yellow border-2 scale-110' : 'border-ios-separator'}`}
                             style={{ left: n.x, top: n.y, background: n.color }}
                             onMouseDown={(e) => handleNodeInteraction(e, n.id, n.x, n.y)}
                             onTouchStart={(e) => handleNodeInteraction(e, n.id, n.x, n.y)}
                        >
                             <input 
                                value={n.text} 
                                onChange={e => onChange({nodes:nodes.map(no=>no.id===n.id?{...no, text:e.target.value}:no), edges})} 
                                className={`bg-transparent text-center w-full h-full outline-none ${mode==='text' ? 'pointer-events-auto' : 'pointer-events-none'}`}
                                placeholder="輸入..."
                             />
                        </div>
                    ))}
                </div>
            );
        };

        const ModeBtn = ({ active, onClick, icon, label }) => (
            <button onClick={onClick} className={`flex flex-col items-center justify-center w-12 h-12 rounded-xl transition-all jelly-click ${active ? 'bg-ios-blue text-white' : 'text-ios-gray hover:bg-white/10'}`}>
                <div className="text-lg">{icon}</div>
                <div className="text-[9px] font-bold mt-0.5">{label}</div>
            </button>
        );

        const FullEditor = ({ chapter, onClose, onSave, apiKey }) => {
            const [data, setData] = useState(JSON.parse(JSON.stringify(chapter)));
            const [tab, setTab] = useState('core');
            const [mode, setMode] = useState('edit'); 
            const [scanning, setScanning] = useState(false);
            const fileRef = useRef(null);

            const handleSave = () => { onSave(data); alert('已儲存'); };
            
            const handleScan = async (e) => {
                const file = e.target.files[0];
                if (!file || !apiKey) return alert('需 API Key');
                setScanning(true);
                const reader = new FileReader();
                reader.onloadend = async () => {
                    try {
                        const base64 = reader.result.split(',')[1];
                        const text = await callGeminiVision(apiKey, "請辨識圖片中的所有文字與數學公式，數學公式請轉為 LaTeX 格式 (使用 $$ 包覆區塊公式，$ 包覆行內公式)。請直接輸出 Markdown 內容。", base64);
                        setData(prev => ({ ...prev, notes: { ...prev.notes, [tab]: (prev.notes[tab] || '') + '\n\n' + text } }));
                        alert('掃描成功！內容已加入。');
                    } catch (err) { alert('辨識失敗: ' + err.message); }
                    setScanning(false);
                };
                reader.readAsDataURL(file);
            };

            const tabs = [ { id: 'core', label: '筆記' }, { id: 'formula', label: '公式' }, { id: 'example', label: '例題' }, { id: 'mindmap', label: '心智圖' } ];

            return (
                <div className="fixed inset-0 z-[100] bg-black flex flex-col pb-safe animate-slide-up">
                    <div className="h-14 border-b border-ios-separator flex items-center justify-between px-4 bg-[#111]">
                        <button onClick={onClose} className="text-ios-blue text-base font-medium">關閉</button>
                        <span className="font-bold text-white truncate max-w-[150px]">{chapter.name}</span>
                        <button onClick={handleSave} className="text-ios-blue text-base font-bold jelly-click">儲存</button>
                    </div>
                    
                    <div className="flex bg-[#111] border-b border-ios-separator overflow-x-auto">
                        {tabs.map(t => (
                            <button key={t.id} onClick={()=>setTab(t.id)} className={`flex-1 py-3 px-2 text-xs font-medium ${tab===t.id?'text-ios-blue border-b-2 border-ios-blue':'text-gray-500'}`}>
                                {t.label}
                            </button>
                        ))}
                    </div>

                    <div className="flex-1 overflow-hidden relative bg-[#000]">
                        {tab === 'mindmap' ? (
                            <MindMapCanvas nodes={data.notes.mindmapNodes || []} edges={data.notes.mindmapEdges || []} onChange={({nodes, edges}) => setData({...data, notes:{...data.notes, mindmapNodes:nodes, mindmapEdges:edges}})} />
                        ) : (
                            <div className="h-full flex flex-col relative">
                                {mode === 'edit' && (
                                    <div className="absolute top-2 right-16 z-20">
                                        <input type="file" ref={fileRef} className="hidden" accept="image/*" onChange={handleScan} />
                                        <button onClick={() => apiKey ? fileRef.current.click() : alert('請先設定 API Key')} className="bg-ios-input text-ios-blue px-3 py-1 rounded-full text-xs flex items-center gap-1 jelly-click">
                                            {scanning ? '...' : <><Icons.Camera /> AI 掃描</>}
                                        </button>
                                    </div>
                                )}
                                <button onClick={() => setMode(mode==='edit'?'preview':'edit')} className="fab-toggle jelly-click">
                                    {mode === 'edit' ? <Icons.Eye /> : <Icons.Edit />}
                                </button>
                                {mode === 'edit' ? (
                                    <textarea className="w-full h-full bg-[#000] text-white p-4 resize-none outline-none font-sans text-base leading-relaxed" 
                                        value={data.notes[tab] || ''} onChange={(e) => setData({...data, notes:{...data.notes, [tab]: e.target.value}})} 
                                        placeholder={`輸入 ${tabs.find(t=>t.id===tab).label}...`} 
                                    />
                                ) : (
                                    <div className="w-full h-full bg-[#000] p-4 overflow-y-auto pb-20">
                                        <MarkdownRenderer content={data.notes[tab]} />
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const AIConsultant = ({ apiKey }) => {
            const [history, setHistory] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [img, setImg] = useState(null); 
            const [showCode, setShowCode] = useState({});
            const scrollRef = useRef(null);
            const fileInput = useRef(null);
            const textareaRef = useRef(null);

            // FIX 1: Only scroll if history has length to prevent initial jump
            useEffect(() => {
                if (history.length > 0) {
                    scrollRef.current?.scrollIntoView({ behavior: 'smooth' });
                }
            }, [history]);

            const handleFile = (e) => {
                const f = e.target.files[0];
                if(f) {
                    const r = new FileReader();
                    r.onloadend = () => setImg(r.result);
                    r.readAsDataURL(f);
                }
            };

            // FIX 2: Auto-resize textarea
            const handleInput = (e) => {
                setInput(e.target.value);
                if (textareaRef.current) {
                    textareaRef.current.style.height = 'auto';
                    textareaRef.current.style.height = `${Math.min(textareaRef.current.scrollHeight, 120)}px`;
                }
            };

            const send = async () => {
                if ((!input && !img) || loading) return;
                const txt = input; const imageToSend = img ? img.split(',')[1] : null;
                setInput(''); setImg(null); setLoading(true);
                
                // Reset height
                if (textareaRef.current) textareaRef.current.style.height = 'auto';

                setHistory(p => [...p, { role: 'user', text: txt, image: img }]);

                try {
                    if (!apiKey) throw new Error("無 API Key");
                    const resText = await callGeminiVision(apiKey, txt || "請分析這張圖片", imageToSend);
                    setHistory(p => [...p, { role: 'model', text: resText }]);
                } catch (e) { setHistory(p => [...p, { role: 'model', text: "Error: " + e.message }]); }
                setLoading(false);
            };

            const toggleCode = (idx) => setShowCode(prev => ({...prev, [idx]: !prev[idx]}));

            return (
                <div className="relative h-full flex flex-col">
                    <div className="flex-1 overflow-y-auto space-y-4 p-4 pb-24"> 
                        {history.length === 0 && <div className="text-center text-ios-gray mt-20 text-sm">我是 AI 顧問，您可以輸入文字或上傳圖片提問。</div>}
                        {history.map((m, i) => (
                            <div key={i} className={`flex flex-col ${m.role==='user'?'items-end':'items-start'}`}>
                                <div className={`max-w-[85%] rounded-2xl p-3 text-base relative ${m.role==='user'?'bg-ios-blue text-white rounded-br-none shadow-lg shadow-blue-900/20':'bg-[#222] text-gray-200 rounded-bl-none border border-white/5'}`}>
                                    {m.image && <img src={m.image} className="rounded-lg mb-2 max-h-48" />}
                                    
                                    {showCode[i] ? (
                                        <pre className="whitespace-pre-wrap font-mono text-xs bg-black/50 p-2 rounded text-ios-yellow border border-white/10">{m.text}</pre>
                                    ) : (
                                        <MarkdownRenderer content={m.text} />
                                    )}

                                    {m.role === 'model' && (
                                        <button 
                                            onClick={() => toggleCode(i)} 
                                            className="absolute -bottom-8 left-0 text-ios-gray text-xs flex items-center gap-1 p-1 bg-black/30 rounded border border-white/10 hover:text-white jelly-click"
                                        >
                                            <Icons.Code /> {showCode[i] ? '預覽' : '原始碼'}
                                        </button>
                                    )}
                                </div>
                                <div className="h-6"></div>
                            </div>
                        ))}
                        {loading && <div className="text-ios-gray text-xs ml-4">Thinking...</div>}
                        <div ref={scrollRef}></div>
                    </div>

                    {/* Updated Capsule Input Area: Vertically Centered & Compact & Neon Glow */}
                    <div className="absolute bottom-2 left-2 right-2 bg-[#1c1c1e] rounded-[30px] p-2 flex items-center gap-2 border border-white/10 shadow-2xl z-30 neon-focus transition-shadow duration-300">
                        <input type="file" ref={fileInput} className="hidden" accept="image/*" onChange={handleFile} />
                        <button onClick={() => fileInput.current.click()} className={`p-2 h-10 w-10 flex items-center justify-center rounded-full transition-colors jelly-click ${img ? 'text-ios-blue bg-ios-blue/10' : 'text-ios-gray hover:bg-white/10'}`}>
                            <Icons.Image />
                        </button>
                        
                        <div className="flex-1 bg-[#2C2C2E] rounded-[24px] px-4 py-1.5 min-h-[36px] border border-white/5 flex flex-col justify-center">
                            {img && <div className="text-[10px] text-ios-blue mb-1 flex justify-between items-center border-b border-white/10 pb-1"><span>圖片已選取</span><button onClick={()=>setImg(null)} className="text-ios-red font-bold px-2 jelly-click">✕</button></div>}
                            <textarea 
                                ref={textareaRef}
                                value={input} 
                                onChange={handleInput} 
                                className="w-full bg-transparent text-white outline-none text-base resize-none auto-grow leading-relaxed placeholder-gray-500" 
                                placeholder="輸入問題..." 
                                rows={1}
                            />
                        </div>

                        <button onClick={send} disabled={loading} className="w-10 h-10 flex-shrink-0 flex items-center justify-center bg-ios-blue rounded-full text-white shadow-lg active:scale-95 transition-transform jelly-click"><Icons.Send /></button>
                    </div>
                </div>
            )
        };
        
        // --- Updated Calendar with Exam Date Analysis ---
        const StudyCalendar = ({ logs, setLogs, deleteLog, subjects, examDate, setExamDate }) => {
            const [form, setForm] = useState({ date: new Date().toISOString().split('T')[0], subj: '', content: '', hours: '' });
            
            const submit = () => { if(form.subj){ setLogs([...logs, {...form, id:Date.now()}]); setForm({...form, content:'', hours:''}); }};
            
            // Analysis Logic
            const today = new Date();
            const exam = examDate ? new Date(examDate) : null;
            const daysLeft = exam ? Math.ceil((exam - today) / (1000 * 60 * 60 * 24)) : null;

            const analysis = useMemo(() => {
                const lowProgressSubjects = subjects.filter(s => {
                    const avg = s.chapters.length ? s.chapters.reduce((a,c)=>a+(c.progress||0),0)/s.chapters.length : 0;
                    return avg < 40;
                });
                return { lowProgressSubjects };
            }, [subjects]);

            return (
                <div className="space-y-6 animate-fade-in pb-20">
                    {/* Exam Date & Analysis Card */}
                    <div className="ios-card p-5 bg-gradient-to-br from-[#111] to-ios-deepGreen/20 border-l-4 border-l-ios-yellow">
                        <div className="flex justify-between items-center mb-3">
                            <h3 className="font-bold text-white flex items-center gap-2"><Icons.Grad /> 備考助手</h3>
                            <input 
                                type="date" 
                                value={examDate} 
                                onChange={(e)=>setExamDate(e.target.value)} 
                                className="bg-black/30 text-white text-xs px-2 py-1 rounded border border-white/10 outline-none" 
                            />
                        </div>
                        {examDate ? (
                            <div className="space-y-2">
                                <div className="text-sm text-gray-300">
                                    距離考試還有 <span className="text-ios-yellow font-bold text-xl mx-1">{daysLeft}</span> 天
                                </div>
                                {analysis.lowProgressSubjects.length > 0 && (
                                    <div className="bg-ios-red/10 p-2 rounded-lg text-xs text-ios-red border border-ios-red/20">
                                        <div className="font-bold mb-1">⚠️ 進度落後科目：</div>
                                        <div>{analysis.lowProgressSubjects.map(s=>s.name).join('、')} (低於 40%)</div>
                                        <div className="mt-1 opacity-80">建議：優先安排這些科目的複習時間。</div>
                                    </div>
                                )}
                                {analysis.lowProgressSubjects.length === 0 && subjects.length > 0 && (
                                    <div className="text-xs text-ios-green">目前進度狀況良好，保持節奏！</div>
                                )}
                            </div>
                        ) : (
                            <div className="text-xs text-gray-500">設定考試日期以獲得進度建議</div>
                        )}
                    </div>

                    <div className="ios-card p-5 bg-[#111]">
                        <h3 className="font-bold text-white mb-4 text-lg">新增紀錄</h3>
                        <div className="space-y-4">
                            <div className="grid grid-cols-2 gap-3">
                                <input type="date" value={form.date} onChange={e=>setForm({...form, date:e.target.value})} className="ios-input w-full p-3 text-center" />
                                <select value={form.subj} onChange={e=>setForm({...form, subj:e.target.value})} className="ios-input w-full p-3"><option value="">科目</option>{subjects.map(s=><option key={s.id} value={s.name}>{s.name}</option>)}</select>
                            </div>
                            <input placeholder="學習內容摘要..." value={form.content} onChange={e=>setForm({...form, content:e.target.value})} className="ios-input w-full p-3" />
                            <div className="flex gap-3">
                                <input type="number" placeholder="時數" value={form.hours} onChange={e=>setForm({...form, hours:e.target.value})} className="ios-input w-24 p-3 text-center" />
                                <button onClick={submit} className="ios-btn flex-1 py-3 jelly-click">記錄</button>
                            </div>
                        </div>
                    </div>

                    <div className="space-y-3">
                        {logs.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(l => (
                            <div key={l.id} className="ios-card p-4 flex gap-4 items-center bg-[#111]">
                                <div className="bg-[#222] px-3 py-2 rounded-xl text-center min-w-[60px]">
                                    <div className="text-xs text-ios-gray font-bold">{l.date.split('-')[1]}月</div>
                                    <div className="text-xl font-bold text-white">{l.date.split('-')[2]}</div>
                                </div>
                                <div className="flex-1">
                                    <div className="text-ios-blue font-bold text-base">{l.subj}</div>
                                    <div className="text-sm text-gray-400">{l.content}</div>
                                </div>
                                <div className="text-white font-mono font-bold text-lg">{l.hours}h</div>
                                <button onClick={() => deleteLog(l.id)} className="text-gray-600 p-2 jelly-click"><Icons.Trash /></button>
                            </div>
                        ))}
                    </div>
                </div>
            )
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>