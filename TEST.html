<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Civil Engineer Pro | Mobile v5</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- KaTeX -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/contrib/auto-render.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        mac: {
                            bg: '#1e1e1e',
                            card: '#252526',
                            panel: '#2d2d2e',
                            border: '#454545',
                            text: '#cccccc',
                            blue: '#0A84FF',
                            red: '#FF453A',
                            green: '#30D158',
                            yellow: '#FFD60A',
                            hover: '#3a3a3c',
                        }
                    },
                    boxShadow: {
                        'mac-window': '0 20px 50px rgba(0,0,0,0.5)',
                        'mac-panel': '0 4px 12px rgba(0,0,0,0.2)',
                        'glow': '0 0 10px rgba(10, 132, 255, 0.3)',
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #1e1e1e;
            color: #e5e5e5;
            background-image: linear-gradient(135deg, #18181b 0%, #27272a 100%);
            overflow-x: hidden;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            padding-bottom: env(safe-area-inset-bottom);
            overscroll-behavior: none; /* Prevent pull-to-refresh on mobile */
        }

        .mac-card {
            background: rgba(37, 37, 38, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
        }
        
        .mac-input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        .mac-input:focus {
            outline: none;
            border-color: #0A84FF;
            background: rgba(0, 0, 0, 0.4);
            box-shadow: 0 0 0 2px rgba(10, 132, 255, 0.2);
        }

        .btn-mac-primary {
            background: #0A84FF;
            color: white;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.2s;
            border: none;
        }
        .btn-mac-primary:active { transform: scale(0.96); }
        
        .btn-mac-secondary {
            background: rgba(255,255,255,0.05);
            color: #ccc;
            border-radius: 8px;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .btn-mac-secondary:active { background: rgba(255,255,255,0.1); }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }

        .markdown-body { font-size: 0.95rem; line-height: 1.6; color: #ddd; word-break: break-word; }
        .markdown-body h1, .markdown-body h2 { border-bottom: 1px solid #444; padding-bottom: 0.3em; margin-top: 1em; color: white; }
        .markdown-body code { background: rgba(255,255,255,0.1); padding: 0.2rem 0.4rem; border-radius: 4px; color: #FFD60A; font-family: monospace; }
        .markdown-body pre { background: #111; padding: 1rem; border-radius: 8px; overflow-x: auto; border: 1px solid #333; }
        .markdown-body img { max-width: 100%; border-radius: 8px; margin: 10px 0; }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Floating Action Button for View Toggle */
        .fab-toggle {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 28px;
            background: #0A84FF;
            color: white;
            box-shadow: 0 4px 15px rgba(10, 132, 255, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 50;
            transition: transform 0.2s;
        }
        .fab-toggle:active { transform: scale(0.9); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        const Icons = {
            Book: () => <i className="fas fa-book"></i>,
            Chart: () => <i className="fas fa-chart-pie"></i>,
            Robot: () => <i className="fas fa-robot"></i>,
            Calendar: () => <i className="fas fa-calendar-alt"></i>,
            Settings: () => <i className="fas fa-cog"></i>,
            Plus: () => <i className="fas fa-plus"></i>,
            Trash: () => <i className="fas fa-trash-alt"></i>,
            Edit: () => <i className="fas fa-pen"></i>,
            Save: () => <i className="fas fa-save"></i>,
            Check: () => <i className="fas fa-check"></i>,
            ArrowRight: () => <i className="fas fa-chevron-right"></i>,
            ArrowLeft: () => <i className="fas fa-chevron-left"></i>,
            Camera: () => <i className="fas fa-camera"></i>,
            Send: () => <i className="fas fa-paper-plane"></i>,
            Link: () => <i className="fas fa-link"></i>,
            Times: () => <i className="fas fa-times"></i>,
            Expand: () => <i className="fas fa-expand"></i>,
            Scan: () => <i className="fas fa-magic"></i>,
            Download: () => <i className="fas fa-file-export"></i>,
            Eye: () => <i className="fas fa-eye"></i>, 
            Columns: () => <i className="fas fa-columns"></i>, 
            Code: () => <i className="fas fa-code"></i>,
            Alert: () => <i className="fas fa-exclamation-triangle"></i>,
        };

        const MarkdownRenderer = ({ content }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (containerRef.current) {
                    let html = marked.parse(content || '');
                    containerRef.current.innerHTML = html;
                    if (window.renderMathInElement) {
                        window.renderMathInElement(containerRef.current, {
                            delimiters: [
                                {left: '$$', right: '$$', display: true},
                                {left: '$', right: '$', display: false}
                            ],
                            throwOnError: false
                        });
                    }
                }
            }, [content]);
            return <div className="markdown-body select-text" ref={containerRef} />;
        };

        // --- App Component ---
        function App() {
            const [view, setView] = useState('dashboard'); 
            const [subjects, setSubjects] = useState([]);
            const [logs, setLogs] = useState([]);
            const [apiKey, setApiKey] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            
            useEffect(() => {
                const s = localStorage.getItem('civil_pro_subjects_v5');
                const l = localStorage.getItem('civil_pro_logs_v5');
                const k = localStorage.getItem('civil_pro_apikey');
                if (s) setSubjects(JSON.parse(s));
                if (l) setLogs(JSON.parse(l));
                if (k) setApiKey(k);
            }, []);

            useEffect(() => localStorage.setItem('civil_pro_subjects_v5', JSON.stringify(subjects)), [subjects]);
            useEffect(() => localStorage.setItem('civil_pro_logs_v5', JSON.stringify(logs)), [logs]);
            useEffect(() => localStorage.setItem('civil_pro_apikey', apiKey), [apiKey]);

            const calculateTotalProgress = () => {
                let total = 0, count = 0;
                subjects.forEach(s => s.chapters.forEach(c => { total += parseInt(c.progress || 0); count++; }));
                return count === 0 ? 0 : Math.round(total / count);
            };

            const addSubject = (name) => setSubjects([...subjects, { id: Date.now(), name, chapters: [] }]);
            const deleteSubject = (id) => setSubjects(subjects.filter(s => s.id !== id));
            
            const addChapter = (sid, name) => {
                setSubjects(subjects.map(s => s.id === sid ? {
                    ...s, chapters: [...s.chapters, { id: Date.now(), name, progress: 0, notes: { core: '', formula: '', example: '', mindmapNodes: [], mindmapEdges: [] } }]
                } : s));
            };
            const deleteChapter = (sid, cid) => {
                setSubjects(subjects.map(s => s.id === sid ? { ...s, chapters: s.chapters.filter(c => c.id !== cid) } : s));
            };
            const updateChapterData = (sid, cid, data) => {
                setSubjects(subjects.map(s => s.id === sid ? {
                    ...s, chapters: s.chapters.map(c => c.id === cid ? { ...c, ...data } : c)
                } : s));
            };

            // New log delete function
            const deleteLog = (id) => {
                if(confirm('確定刪除此紀錄？')) {
                    setLogs(logs.filter(l => l.id !== id));
                }
            };

            return (
                <div className="min-h-[100dvh] flex flex-col bg-mac-bg text-mac-text font-sans pb-safe">
                    {/* Header */}
                    <nav className="bg-mac-card/90 backdrop-blur border-b border-white/5 px-4 py-3 flex items-center justify-between sticky top-0 z-50">
                        <div className="flex items-center gap-2">
                            <span className="bg-mac-blue w-7 h-7 rounded-lg flex items-center justify-center text-xs font-bold text-white shadow-glow">CP</span>
                            <h1 className="text-lg font-bold text-white tracking-tight">Civil Pro v5</h1>
                        </div>
                        <button onClick={() => setShowSettings(true)} className="text-gray-400 p-2"><Icons.Settings /></button>
                    </nav>

                    {/* Main Content Area */}
                    <main className="flex-1 p-4 overflow-y-auto pb-24 scroll-smooth">
                        {view === 'dashboard' && <Dashboard subjects={subjects} totalProgress={calculateTotalProgress()} setView={setView} />}
                        {view === 'subjects' && <SubjectManager subjects={subjects} addSubject={addSubject} deleteSubject={deleteSubject} addChapter={addChapter} deleteChapter={deleteChapter} updateChapterData={updateChapterData} apiKey={apiKey} />}
                        {view === 'ai' && <AIConsultant apiKey={apiKey} />}
                        {view === 'calendar' && <StudyCalendar logs={logs} setLogs={setLogs} deleteLog={deleteLog} subjects={subjects} />}
                    </main>

                    {/* Bottom Navigation */}
                    <div className="fixed bottom-0 left-0 right-0 bg-mac-card/95 backdrop-blur border-t border-white/5 p-2 pb-safe z-40 flex justify-around">
                        <NavBtn active={view === 'dashboard'} onClick={() => setView('dashboard')} icon={<Icons.Chart />} label="儀表板" />
                        <NavBtn active={view === 'subjects'} onClick={() => setView('subjects')} icon={<Icons.Book />} label="筆記" />
                        <NavBtn active={view === 'ai'} onClick={() => setView('ai')} icon={<Icons.Robot />} label="AI" />
                        <NavBtn active={view === 'calendar'} onClick={() => setView('calendar')} icon={<Icons.Calendar />} label="進度" />
                    </div>

                    {/* Settings Modal */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4">
                            <div className="mac-card p-6 w-full max-w-sm">
                                <h3 className="text-xl font-bold text-white mb-4">設定</h3>
                                <div className="mb-4">
                                    <label className="block text-xs text-mac-blue mb-1">Gemini API Key</label>
                                    <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} className="mac-input w-full p-3 text-sm" placeholder="貼上 API Key" />
                                </div>
                                <button onClick={() => setShowSettings(false)} className="btn-mac-primary w-full py-2">完成</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const NavBtn = ({ active, onClick, icon, label }) => (
            <button onClick={onClick} className={`flex flex-col items-center gap-1 p-2 rounded-lg w-16 transition ${active ? 'text-mac-blue' : 'text-gray-500'}`}>
                <span className="text-xl">{icon}</span>
                <span className="text-[10px] font-medium">{label}</span>
            </button>
        );

        const Dashboard = ({ subjects, totalProgress, setView }) => (
            <div className="space-y-4 animate-fade-in">
                <div className="mac-card p-6 bg-gradient-to-br from-mac-blue/20 to-transparent border-mac-blue/30">
                    <div className="text-xs text-mac-blue font-bold uppercase tracking-wider mb-1">總掌握度</div>
                    <div className="flex items-end gap-2">
                        <span className="text-6xl font-semibold text-white">{totalProgress}</span>
                        <span className="text-xl text-gray-400 mb-2">%</span>
                    </div>
                    <div className="h-2 bg-black/40 rounded-full mt-4 overflow-hidden">
                        <div className="h-full bg-mac-blue transition-all duration-1000" style={{width: `${totalProgress}%`}}></div>
                    </div>
                </div>

                <div className="grid grid-cols-1 gap-4">
                    {subjects.map(s => {
                         const p = s.chapters.length ? Math.round(s.chapters.reduce((a,c)=>a+(c.progress||0),0)/s.chapters.length) : 0;
                         return (
                            <div key={s.id} onClick={() => setView('subjects')} className="mac-card p-5 active:scale-[0.98] transition-transform">
                                <div className="flex justify-between mb-2">
                                    <h3 className="font-bold text-white">{s.name}</h3>
                                    <span className="text-xs bg-white/10 px-2 py-1 rounded text-gray-300">{s.chapters.length} 章</span>
                                </div>
                                <div className="flex justify-between text-xs text-gray-500 mb-1">
                                    <span>進度</span>
                                    <span>{p}%</span>
                                </div>
                                <div className="h-1.5 bg-black/30 rounded-full overflow-hidden">
                                    <div className="h-full bg-mac-green" style={{width: `${p}%`}}></div>
                                </div>
                            </div>
                         )
                    })}
                </div>
            </div>
        );

        // --- Subject Manager (Fixed Delete Button) ---
        const SubjectManager = ({ subjects, addSubject, deleteSubject, addChapter, deleteChapter, updateChapterData, apiKey }) => {
            const [activeSubjId, setActiveSubjId] = useState(null);
            const [editingChapter, setEditingChapter] = useState(null);
            const [newSubjName, setNewSubjName] = useState('');

            const activeSubj = subjects.find(s => s.id === activeSubjId);

            if (editingChapter) {
                return <FullEditor subjectId={editingChapter.subjectId} chapter={editingChapter.chapter} onClose={() => setEditingChapter(null)} onSave={(d) => updateChapterData(editingChapter.subjectId, editingChapter.chapter.id, d)} apiKey={apiKey} />;
            }

            if (activeSubj) {
                return (
                    <div className="animate-fade-in h-full flex flex-col">
                        <button onClick={() => setActiveSubjId(null)} className="flex items-center gap-2 text-gray-400 mb-4 hover:text-white p-2">
                            <Icons.ArrowLeft /> 返回科目列表
                        </button>
                        <div className="mac-card p-4 mb-4 flex justify-between items-center bg-mac-panel">
                            <h2 className="text-xl font-bold text-white">{activeSubj.name}</h2>
                            <ChapterInput onAdd={(n) => addChapter(activeSubj.id, n)} />
                        </div>
                        <div className="space-y-4 pb-20">
                            {activeSubj.chapters.map(chap => (
                                <div key={chap.id} className="mac-card p-4">
                                    <div className="flex justify-between items-start mb-3">
                                        <h4 className="font-bold text-lg text-white">{chap.name}</h4>
                                        <button 
                                            onClick={(e) => { e.stopPropagation(); if(confirm('確定刪除此章節？')) deleteChapter(activeSubj.id, chap.id); }} 
                                            className="text-gray-400 hover:text-mac-red p-2"
                                        >
                                            <Icons.Trash />
                                        </button>
                                    </div>
                                    <div className="flex items-center gap-3 mb-4">
                                        <input type="range" className="flex-1 accent-mac-blue" value={chap.progress} onChange={(e) => updateChapterData(activeSubj.id, chap.id, {progress: parseInt(e.target.value)})} />
                                        <span className="text-xs text-gray-400 w-8 text-right">{chap.progress}%</span>
                                    </div>
                                    <button onClick={() => setEditingChapter({ subjectId: activeSubj.id, chapter: chap })} className="w-full btn-mac-primary py-2.5 rounded-lg text-sm flex items-center justify-center gap-2">
                                        <Icons.Edit /> 進入筆記
                                    </button>
                                </div>
                            ))}
                            {activeSubj.chapters.length === 0 && <div className="text-center text-gray-500 py-10">尚無章節</div>}
                        </div>
                    </div>
                );
            }

            return (
                <div className="animate-fade-in pb-20">
                    <div className="mac-card p-3 flex gap-2 mb-4">
                        <input value={newSubjName} onChange={(e) => setNewSubjName(e.target.value)} placeholder="新增科目..." className="mac-input flex-1 px-3 py-2 text-sm" />
                        <button onClick={() => { if(newSubjName){ addSubject(newSubjName); setNewSubjName(''); }}} className="btn-mac-secondary px-3"><Icons.Plus /></button>
                    </div>
                    <div className="space-y-2">
                        {subjects.map(s => (
                            <div key={s.id} onClick={() => setActiveSubjId(s.id)} className="mac-card p-4 flex justify-between items-center active:bg-mac-hover transition">
                                <div>
                                    <div className="font-medium text-white">{s.name}</div>
                                    <div className="text-xs text-gray-500">{s.chapters.length} 個章節</div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <Icons.ArrowRight />
                                    <button 
                                        onClick={(e) => { 
                                            e.stopPropagation(); // Explicit stop propagation
                                            if(confirm(`確定要刪除「${s.name}」科目嗎？所有內容將消失。`)) deleteSubject(s.id); 
                                        }} 
                                        className="text-gray-500 hover:text-mac-red p-3 z-10" // Increased padding for touch target
                                    >
                                        <Icons.Trash />
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ChapterInput = ({ onAdd }) => {
            const [v, sV] = useState('');
            return <div className="flex gap-2"><input value={v} onChange={e=>sV(e.target.value)} placeholder="章節名" className="mac-input w-24 px-2 py-1 text-sm" /><button onClick={()=>{if(v){onAdd(v);sV('')}}} className="text-mac-blue p-2"><Icons.Plus /></button></div>
        }

        // --- Fixed Mind Map (Better Touch Support & Unique IDs) ---
        const MindMapCanvas = ({ nodes, edges, onChange }) => {
            const svgRef = useRef(null);
            const [draggingId, setDraggingId] = useState(null);
            const [offset, setOffset] = useState({x:0, y:0});

            // Improved Touch/Mouse Handling
            const getPos = (e) => {
                const rect = svgRef.current.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };

            const startDrag = (e, id, nx, ny) => {
                e.stopPropagation(); 
                // Prevent default usually helps with touch scrolling issues, but might block clicking input.
                // We use touch-action: none on container instead.
                const pos = getPos(e);
                setDraggingId(id);
                setOffset({ x: pos.x - nx, y: pos.y - ny });
            };

            const onMove = (e) => {
                if (!draggingId) return;
                const pos = getPos(e);
                onChange({
                    nodes: nodes.map(n => n.id === draggingId ? { ...n, x: pos.x - offset.x, y: pos.y - offset.y } : n),
                    edges
                });
            };

            const stopDrag = () => setDraggingId(null);

            const addNode = () => {
                // Fix: Generate truly unique ID to prevent duplicates failing
                const newId = Date.now().toString() + Math.random().toString(36).substr(2, 5);
                const newNode = { id: newId, x: 50 + Math.random()*50, y: 50 + Math.random()*50, text: 'New', color: '#2c2c2e' };
                onChange({ nodes: [...nodes, newNode], edges });
            };

            // Link logic omitted for brevity on mobile, focusing on drag/add
            return (
                <div className="relative w-full h-full bg-[#18181b] overflow-hidden rounded border border-[#333] touch-none" 
                     ref={svgRef} 
                     onMouseMove={onMove} 
                     onTouchMove={onMove} 
                     onMouseUp={stopDrag} 
                     onMouseLeave={stopDrag}
                     onTouchEnd={stopDrag}
                >
                    <button onClick={addNode} className="absolute top-2 left-2 z-10 btn-mac-primary px-3 py-1 text-xs shadow-lg"><Icons.Plus /> 節點</button>
                    <svg className="absolute inset-0 w-full h-full pointer-events-none">
                        {edges.map((e, i) => {
                            const s = nodes.find(n => n.id === e.source), t = nodes.find(n => n.id === e.target);
                            return s && t ? <line key={i} x1={s.x+70} y1={s.y+25} x2={t.x+70} y2={t.y+25} stroke="#555" strokeWidth="2" /> : null;
                        })}
                    </svg>
                    {nodes.map(n => (
                        <div key={n.id} 
                             className="absolute w-[140px] h-[50px] rounded-lg border border-gray-600 flex items-center justify-center text-white text-sm shadow-lg select-none"
                             style={{ left: n.x, top: n.y, background: n.color }}
                             onMouseDown={(e) => startDrag(e, n.id, n.x, n.y)}
                             onTouchStart={(e) => startDrag(e, n.id, n.x, n.y)}
                        >
                             <input 
                                value={n.text} 
                                onChange={e => onChange({nodes:nodes.map(no=>no.id===n.id?{...no, text:e.target.value}:no), edges})} 
                                className="bg-transparent text-center w-full h-full outline-none" 
                                onMouseDown={e => e.stopPropagation()} 
                                onTouchStart={e => e.stopPropagation()} 
                             />
                        </div>
                    ))}
                </div>
            );
        };

        // --- Full Features Editor (Toggle Mode) ---
        const FullEditor = ({ chapter, onClose, onSave, apiKey }) => {
            const [data, setData] = useState(JSON.parse(JSON.stringify(chapter)));
            const [tab, setTab] = useState('core');
            const [mode, setMode] = useState('edit'); // 'edit' or 'preview'
            
            const handleSave = () => { onSave(data); alert('已儲存'); };
            
            const tabs = [
                { id: 'core', label: '核心筆記' },
                { id: 'formula', label: '公式' },
                { id: 'example', label: '例題' },
                { id: 'mindmap', label: '心智圖' }
            ];

            return (
                <div className="fixed inset-0 z-[100] bg-mac-bg flex flex-col animate-fade-in pb-safe">
                    <div className="h-12 border-b border-[#333] flex items-center justify-between px-4 bg-[#252526]">
                        <button onClick={onClose} className="text-gray-400 p-2"><Icons.Times /></button>
                        <span className="font-bold text-white truncate max-w-[150px]">{chapter.name}</span>
                        <button onClick={handleSave} className="text-mac-blue font-bold text-sm p-2"><Icons.Save /> 儲存</button>
                    </div>
                    
                    {/* Scrollable Tabs */}
                    <div className="flex bg-[#1e1e1e] border-b border-[#333] overflow-x-auto">
                        {tabs.map(t => (
                            <button key={t.id} onClick={()=>setTab(t.id)} className={`flex-1 py-3 px-4 whitespace-nowrap text-xs font-medium ${tab===t.id?'text-mac-blue border-b-2 border-mac-blue':'text-gray-500'}`}>
                                {t.label}
                            </button>
                        ))}
                    </div>

                    <div className="flex-1 overflow-hidden relative bg-[#1e1e1e]">
                        {tab === 'mindmap' ? (
                            <MindMapCanvas nodes={data.notes.mindmapNodes || []} edges={data.notes.mindmapEdges || []} onChange={({nodes, edges}) => setData({...data, notes:{...data.notes, mindmapNodes:nodes, mindmapEdges:edges}})} />
                        ) : (
                            <div className="h-full flex flex-col relative">
                                {/* Toggle Button (FAB) */}
                                <button 
                                    onClick={() => setMode(mode==='edit'?'preview':'edit')} 
                                    className="fab-toggle"
                                    title={mode === 'edit' ? "切換至預覽" : "切換至編輯"}
                                >
                                    {mode === 'edit' ? <Icons.Eye /> : <Icons.Edit />}
                                </button>

                                {mode === 'edit' ? (
                                    <textarea 
                                        className="w-full h-full bg-[#1e1e1e] text-gray-200 p-4 resize-none outline-none font-mono text-base leading-relaxed" 
                                        value={data.notes[tab] || ''} 
                                        onChange={(e) => setData({...data, notes:{...data.notes, [tab]: e.target.value}})} 
                                        placeholder={`在此輸入 ${tabs.find(t=>t.id===tab).label} (支援 Markdown/LaTeX)...`} 
                                    />
                                ) : (
                                    <div className="w-full h-full bg-[#1e1e1e] p-4 overflow-y-auto pb-20">
                                        <MarkdownRenderer content={data.notes[tab]} />
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- AI Consultant with Code Toggle ---
        const AIConsultant = ({ apiKey }) => {
            const [history, setHistory] = useState([]);
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [showCode, setShowCode] = useState({}); // Track code view per message
            const scrollRef = useRef(null);

            useEffect(() => scrollRef.current?.scrollIntoView({ behavior: 'smooth' }), [history]);

            const send = async () => {
                if (!input || loading) return;
                const userText = input; setInput(''); setLoading(true);
                setHistory(prev => [...prev, { role: 'user', text: userText }]);
                try {
                    if (!apiKey) throw new Error("無 API Key");
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: userText }] }] })
                    });
                    const data = await res.json();
                    setHistory(prev => [...prev, { role: 'model', text: data.candidates[0].content.parts[0].text }]);
                } catch (e) { setHistory(prev => [...prev, { role: 'model', text: "Error: " + e.message }]); }
                setLoading(false);
            };

            const toggleCode = (idx) => {
                setShowCode(prev => ({...prev, [idx]: !prev[idx]}));
            }

            return (
                <div className="flex flex-col h-[calc(100vh-180px)]">
                    <div className="flex-1 overflow-y-auto space-y-4 pb-4 px-1">
                        {history.length === 0 && <div className="text-center text-gray-500 mt-10">我是 AI 顧問，請隨時發問。</div>}
                        {history.map((m, i) => (
                            <div key={i} className={`flex flex-col ${m.role==='user'?'items-end':'items-start'}`}>
                                <div className={`max-w-[90%] rounded-2xl p-3 text-sm relative group ${m.role==='user'?'bg-mac-blue text-white':'bg-[#333] text-gray-200'}`}>
                                    {showCode[i] ? (
                                        <div className="font-mono text-xs whitespace-pre-wrap text-yellow-300 overflow-x-auto">{m.text}</div>
                                    ) : (
                                        <MarkdownRenderer content={m.text} />
                                    )}
                                    {m.role === 'model' && (
                                        <button 
                                            onClick={() => toggleCode(i)}
                                            className="absolute -bottom-6 left-0 text-gray-500 hover:text-white text-xs bg-[#444] px-2 py-1 rounded-full border border-gray-600 flex items-center gap-1"
                                        >
                                            <Icons.Code /> {showCode[i] ? '預覽' : '原始碼'}
                                        </button>
                                    )}
                                </div>
                                <div className="h-4"></div> {/* Spacing for button */}
                            </div>
                        ))}
                        <div ref={scrollRef}></div>
                    </div>
                    <div className="flex gap-2 mt-2">
                        <input value={input} onChange={e=>setInput(e.target.value)} className="mac-input flex-1 p-3 text-sm" placeholder="輸入問題..." />
                        <button onClick={send} disabled={loading} className="btn-mac-primary px-4"><Icons.Send /></button>
                    </div>
                </div>
            )
        };
        
        // --- Study Calendar with Delete ---
        const StudyCalendar = ({ logs, setLogs, deleteLog, subjects }) => {
            const [form, setForm] = useState({ date: new Date().toISOString().split('T')[0], subj: '', content: '', hours: '' });
            const submit = () => { if(form.subj){ setLogs([...logs, {...form, id:Date.now()}]); setForm({...form, content:'', hours:''}); }};
            return (
                <div className="space-y-6 animate-fade-in pb-20">
                    <div className="mac-card p-4">
                        <h3 className="font-bold text-white mb-3">新增紀錄</h3>
                        <div className="space-y-3">
                            <input type="date" value={form.date} onChange={e=>setForm({...form, date:e.target.value})} className="mac-input w-full p-2" />
                            <select value={form.subj} onChange={e=>setForm({...form, subj:e.target.value})} className="mac-input w-full p-2"><option value="">科目</option>{subjects.map(s=><option key={s.id} value={s.name}>{s.name}</option>)}</select>
                            <div className="flex gap-2">
                                <input placeholder="內容" value={form.content} onChange={e=>setForm({...form, content:e.target.value})} className="mac-input flex-1 p-2" />
                                <input type="number" placeholder="時" value={form.hours} onChange={e=>setForm({...form, hours:e.target.value})} className="mac-input w-16 p-2" />
                            </div>
                            <button onClick={submit} className="btn-mac-primary w-full py-2">記錄</button>
                        </div>
                    </div>
                    <div className="space-y-2">
                        {logs.sort((a,b)=>new Date(b.date)-new Date(a.date)).map(l => (
                            <div key={l.id} className="mac-card p-3 flex gap-3 items-center group relative overflow-hidden">
                                <div className="bg-[#333] px-2 py-1 rounded text-center"><div className="text-[10px] text-gray-400">{l.date.split('-')[1]}/{l.date.split('-')[2]}</div></div>
                                <div className="flex-1"><div className="text-mac-blue font-bold text-sm">{l.subj}</div><div className="text-xs text-gray-400">{l.content}</div></div>
                                <div className="font-mono text-gray-500 mr-8">{l.hours}h</div>
                                {/* Delete Button for Log */}
                                <button 
                                    onClick={() => deleteLog(l.id)} 
                                    className="absolute right-0 top-0 bottom-0 w-12 bg-red-500/10 text-red-500 hover:bg-red-500 hover:text-white flex items-center justify-center transition-all"
                                >
                                    <Icons.Trash />
                                </button>
                            </div>
                        ))}
                    </div>
                </div>
            )
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>